---
title: 项目中遇到的问题和解决办法
tags:
  - null
categories:
  - null
date: 2018-03-31 23:42:10
thumbnail:
---



# 一、基于 Lumen 的 RESTful 风格 API

## 设计层面

### 1. RESTful 在有些地方用起来并不畅快 

- login 和 loginout
- 204 不返回任何内容，即时你设定了，这样和其他有具体返回信息的状态码相比，很不和谐
- DELETE 时 body可能会被网关等剥离，删除多个数据时，很不方便

**我对 RESTful 的看法**

RESTful 是一个优秀的架构风格，可以解决很多问题，但无法解决所有问题。虽然说可以换个角度，把登录、注销看成是 session 或 token 的创建和注销，然后通过逻辑调整或奇淫巧技解决 DELETE 和 204 的问题。可这样仔细一想很不必要。所以我觉得不能为了 RESTful 而 RESTful ，因为它毕竟只是一种架构风格，不是装订成册的设计规范。

因此我觉得最好的办法是，把它作为一个大纲参考，结合自身业务实际，在不脱离大纲太远的情况下对一些细节灵活制定一个详细的规范。即不是 30% 的半吊子RESTful，也不是 100% 的纯RESTful，而是 95% 的RESTful。



### 2. JWT 的安全策略

如果 JWT Token 被泄露了，怎么办？

首先第一点，防止泄露的手段：

- 使用https协议，并使用 application/json 传输方式或 header 传输方式来传输 token，可以避免泄露
- 设置cookie的HttpOnly属性
- 重复过滤用户的输入

然后第二点，万一泄露的手段：

- 在token的载荷中嵌入客户端指纹。例如在颁发token时，在客户机的UA、操作系统版本、浏览器分辨率、时区差、语言、Public IP、本机IP等多个可以获取到的信息中取几个在服务端以特定方式组合，然后取摘要甚至加密，嵌入token的载荷中，每次调用前都鉴定请求方和token的对应关系，这样即使token被盗，也安然无恙。

- 设定合适的token过期时间和刷新时间。

  ​



###3. Lumen文档

关于Laravel的文档很多，但是Lumen就那么丰富了，很多小坑大坑都坑了我蛮长一段时间，比如 lumen 有些artisan命令没有，然后你被人Laravel + dingo + jwt 看文档这么写就毫无问题，我这Lumen + dingo + jwt就不行。这一点的解决办法的话，就是查英文资料，英文搜google，查看系统和轮子的原理，推测，然后尝试。



### 4. 权限设定

因为我们API的面向对象十分广泛，有内部开发者，内部产品、本校开发者等。所以权限制定必须要非常灵活。所以当初权限花了点心思，最后采用的是基于角色的访问控制，然后对角色身份的权限分配还划分了两层。实现灵活的角色权限定制和灵活的用户权限授予。



### 5. 登录状态

用户信息的安全问题。

因为要实现登陆保存sessionid，下次再用时先看sessionid能不能用，不能再用之前保存的密码重新获取一次sessionid。就涉及到了用户密码的保存问题，所以当时采取的措施主要有两个：

- 数据库密码加密
- 起草用户协议，声明这方面的保存



### 6. 统一登录

我们学校系统很多，密码也不统一，所以API还有一个任务就是统一密码。

采用的做法是让用户绑定各个系统的密码，当然也不强制，绑定你需要用到的即可。然后选取两个最常用的系统，教务和信息门户，用户登录的时候只要输入这其中任意的一个密码就可以登录所有绑定过的系统。当然这也要考虑安全因素，因为学校系统的默认密码一般是身份证的后六位，虽然这种信息攻击者一般弄不到，但是考虑最坏情况，不接受没有改默认密码的绑定，这状态在模拟登陆的时候可以判定出来，所以做到也不难。



### 7. 维护性和扩展性

为了系统以后的可扩展性和维护性，对整个系统的架构要有一定的设计。

最后的办法是像网络原理里的各种协议一样，进行分层。分了三层：

- 第一层是API权限控制系统：对于权限的控制和API的注册都是这一层的任务
- 第二层是Passport统一登录系统：负责登录检验和token的颁发
- 第三层分有各个子系统并列：教务、信息门户、图书馆、一卡通等，负责各个子系统的详细数据获取



### 8. 模拟登陆的简单验证码识别

1. 8领域降噪：将周围8个像素中6、7、8方向为白色的点变成白色，如果处理不干净在保证不损坏核心的情况下可以多处理几次
2. 二值化：把验证码中非白色像素化为1，其余化为0
3. 二值化再去噪：一列若果只有一个1，把这一列全部变成0
4. 二值化切割：从上到下把全零的行去掉，直到遇到有1的元素为止，其他三个方向也一次执行一次。
5. 二值化分割：从左至右一列一列读取，只要不是全0就存到数组，直到遇到全0的列停止储存继续遍历，遇到新的不是全0列时存到第二个数组，直到遍历完。
6. 校验字符个数：如果识别到的是4个字符，成功，否则报错重试
7. 提取特征：多跑几次，把验证码用到的字符都跑一遍，存储其字符数组（特征）到数据库
8. 以后新的验证码就用同一个算法切割提取成数组，然后依次和数据库保存的特征比对，相似度最高的就是这个字符





# 二、SkyVote在线投票系统

### 1. 用户身份鉴权

为了鉴别用户身份，使用QQ的Oauth2.0授权，外加一个Excel表自动导入。每个活动可自由选择这里面支持的方式。



### 2. 对刷票数据的鉴别

记录了每一票的详细信息，比如IP、投票地，后台用chatjs和表格将数据可视化显示，通过和正常数据的对比，可以快速定位异常数据，并进行分析。

真实 IP 的获取：

`$_SERVER['HTTP_CLIENT_IP']`和`$_SERVER['HTTP_X_FORWARDED_FOR']`都来自客户端请求的header里面，所以可以伪造，`$_SERVER['REMOTE_ADDR']` 是可靠的。



### 3. 系统可以使用的范围 

为扩大系统的可使用常见，支持图片、视频、音频、外链等四种。但是视频因为大小问题和服务器带宽问题难以解决，最后想到的是用上传到腾讯视频，用腾讯视频提供的页面标签。



### 4. 图片加载

摄影比赛时用户上传的多为大图，导致页面加载时需要很多的流量，且加载慢。处理办法是一方面把用户上传的图片压缩至适合的大小，一方面在前台页面使用 lazyload。



### * 5. 投票队列

信息放到 redis 中，Redis慢慢持久化存入mysql。



# 三、微信小程序

### 1. JavaScript 闭包

循环获取8个学期的绩点时都是获取到最后一个学期的。

解决办法：使用自执行函数将每次循环的值传入，利用闭包的机制保存。



### 2. js 分号

看到一篇文章说 JS 可以不用加分号作为结束，而且这样可能更好，所以在这整个项目中就试了一下，整个项目下来，感觉差不多。



### 3. 异步数据获取处理

异步数据获取处理，数据的设置这一步在异步数据还没返回前就执行了，导致报错。

把数据处理作为匿名函数，当做参数传入数据获取的方法，数据获取后会判断参数是否是可调用的函数，如果事把获取到的数据作为参数传给匿名函数。



### 4. Flex 布局

弹性布局。

```css
.box{
    /* 先指定一个容器为 Flex 布局 */
    display: -webkit-flex; /* Safari 等 webkit 内核的浏览器 */
  	display: flex;
    /* 指定主轴排列-水平轴 */
    flex-direction: row | row-reverse | column | column-reverse;
    /* 换行方式 */
    flex-wrap: nowrap | wrap | wrap-reverse;
    /* 主轴上的对齐方式 */
    justify-content: flex-start | flex-end | center | space-between | space-around;
    
    /* 交叉轴上如何对齐方式 */
    align-items: flex-start | flex-end | center | baseline | stretch;
    /* 定义多根轴线的对齐方式。如果项目只有一根轴线，该属性不起作用。 */
	align-content: flex-start | flex-end | center | space-between | space-around | stretch;
}

.item{
    /* 子元素的属性定义，如权值和优先级等 */
}
```



# 四、知行 APP

### 1. 接触了设计风格这一概念

仔细看了 Google 的 Material Design 设计风格。

色彩、层次、纸片。



### 2. 技术点

- 补间动画
- SQLite
- gradle 依赖管理
- 沉浸式的状态栏
- 使用图片导致内存泄露，用Picasso的库
- 百度的SDK包
- 图标库

